# Project Structure and Module Overview

This document provides an overview of the modular structure of the TradeBot project, detailing the purpose of each module, its dependencies, and the overall directory layout.

## Directory Structure
- **Root Directory (`C:\Users\Dennis\.vscode\tradebot`)**:
  - `.env`: Environment variables for API keys and configuration.
  - `.gitattributes`: Git configuration for handling file attributes.
  - `BTC-USD_backtest_results.png`: Output plot from backtest visualization.
  - `README.md`: Project overview and setup instructions.
  - `analyze_model.py`: Script to analyze model performance.
  - `app.py`: Main application script (likely for running the trading bot).
  - `backtest_results.json`: JSON file storing backtest performance metrics.
  - `best_model.pth`: Saved transformer model weights (best overall).
  - `best_model_fold1.pth` to `best_model_fold5.pth`: Saved model weights for cross-validation folds (generated when k-fold cross-validation is enabled in `train_transformer_model.py`).
  - `btc_usd_historical.csv`: Historical BTC/USD data.
  - `btc_usd_historical_mtgox.csv`: Historical BTC/USD data from Mt. Gox.
  - `checkpoint_fold1_epochX.pth` to `checkpoint_fold5_epochX.pth`: Checkpoint files for each fold and epoch during training (generated when k-fold cross-validation is enabled).
  - `combine_data.py`: Script to combine multiple data sources.
  - **docs/**:
    - `project_structure.md`: This file, documenting the project structure.
  - `feature_scaler.pkl`: Saved feature scaler for preprocessing.
  - `fetch_btc_usd_data.py`: Script to fetch BTC/USD data.
  - `fetch_btc_usd_data_mtgox.py`: Script to fetch BTC/USD data from Mt. Gox.
  - `fold_metadata.json`: Metadata for cross-validation folds (used when k-fold cross-validation is enabled).
  - `fold_metrics.json`: Metrics for each fold from k-fold cross-validation (generated by `train_transformer_model.py`).
  - `indicators.log`: Log file for indicator calculations.
  - **logs/**: Directory for log files (currently empty).
  - `price_predictions.png`: Plot of price predictions (overall best model).
  - `price_predictions_fold1.png` to `price_predictions_fold5.png`: Plots of price predictions for each fold (generated when k-fold cross-validation is enabled).
  - `print_tree.py`: Script to print the project directory tree.
  - `pytest.ini`: Configuration for pytest.
  - `requirements.txt`: List of Python dependencies.
  - `scaler.pkl`: Legacy scaler file (possibly replaced by `feature_scaler.pkl` and `target_scaler.pkl`).
  - `sentiment.log`: Log file for sentiment analysis.
  - `signals.log`: Log file for signal generation.
  - **src/**: Source code directory
    - **api/**:
      - `coinbase.py`: API client for Coinbase.
      - `gemini.py`: API client for Gemini.
    - `constants.py`: Defines constants like `FEATURE_COLUMNS`, signal weights (e.g., `WEIGHT_LUXALGO`, `WEIGHT_TRENDSPIDER`), and toggles like `USE_SMRT_SCALPING`.
    - `dashboard.py`: Dashboard application for visualizing trading metrics.
    - **data/**:
      - `btc_usd_historical.csv`: Copy of historical data (also in root).
      - `data_fetcher.py`: Fetches historical data from CSV or API.
      - `data_manager.py`: Orchestrates data loading, preprocessing, and scaling; ensures `FEATURE_COLUMNS` are scaled.
      - `data_preprocessor.py`: Preprocesses raw data, computes technical indicators, and generates signals (e.g., LuxAlgo, TrendSpider, SMRT Scalping).
      - `gemini_websocket.py`: WebSocket client for Gemini real-time data.
      - `generate_synthetic_data.py`: Generates synthetic data for testing.
      - **logs/**:
        - `data_fetcher.log`: Log file for data fetching operations.
    - **features/**:
      - `feature_importance.py`: Analyzes feature importance for the model.
      - `time_series_features.py`: Generates time-series features.
    - `main_new.py`: Alternative main script (possibly for live trading or a different pipeline).
    - **models/**:
      - `model_predictor.py`: Handles model predictions.
      - `train_transformer_model.py`: Trains the transformer model with k-fold cross-validation and checkpointing.
      - `transformer_model.py`: Defines the `TransformerPredictor` model for price prediction.
    - `scheduler_new.py`: Scheduler for automated tasks (e.g., data fetching, trading).
    - **static/js/**:
      - `dashboard.js`: JavaScript for the dashboard frontend.
    - **strategy/**:
      - `backtest_engine.py`: Executes backtesting of the trading strategy, calculating metrics like Sharpe ratio.
      - `backtest_visualizer_ultimate.py`: Main script to run the backtest, optimize weights, and visualize results.
      - `execution.py`: Handles trade execution (likely for live trading).
      - `indicators.py`: Computes technical indicators (possibly redundant with `data_preprocessor.py`).
      - `market_regime.py`: Detects market regimes (e.g., Bullish, Bearish, Neutral).
      - `optimizer.py`: Optimizes signal weights (e.g., LuxAlgo, TrendSpider) using grid search to maximize Sharpe ratio.
      - `parameter_optimizer.py`: Optimizes strategy parameters (e.g., RSI thresholds, MACD periods) based on market conditions.
      - `position_sizer.py`: Calculates position sizes using methods like ATR-based sizing, Kelly Criterion, and Monte Carlo simulations.
      - `risk_manager.py`: Manages risk by adjusting position sizes, enforcing drawdown limits, and setting stop-loss/take-profit levels.
      - `sentiment_analysis.py`: Simulates sentiment analysis (e.g., X sentiment, Fear & Greed Index) for market sentiment features.
      - `signal_filter.py`: Filters signals based on market conditions, trends, volatility, and confidence thresholds; generates SMRT scalping signals if enabled.
      - `signal_generator.py`: Generates raw trading signals using the transformer model and weighted combination of indicators.
      - `signal_manager.py`: Orchestrates signal generation and filtering, passing weights to `signal_generator.py`.
    - **templates/**:
      - `dashboard.html`: HTML template for the dashboard.
    - **trading/**:
      - `paper_trader.py`: Implements a paper trading simulator.
    - **utils/**:
      - `config.py`: Configuration utilities.
      - `logger.py`: Custom logging utilities.
      - `sequence_utils.py`: Creates sequences for transformer model input.
      - `time_utils.py`: Calculates time-related features (e.g., days to next halving).
    - **visualization/**:
      - `visualizer.py`: Plots backtest results and performance metrics.
  - `target_scaler.pkl`: Saved target scaler for preprocessing.
  - `test_api.py`: Tests for API clients.
  - **tests/**:
    - `test_data_fetcher.py`: Unit tests for `data_fetcher.py`.
    - `test_trader.py`: Unit tests for trading components (e.g., `paper_trader.py`).
  - `trade_data.json`: JSON file storing trade history from backtests.
  - `trading_bot.log`: Log file for the trading bot.
  - `vpvr.log`: Log file for VPVR calculations.

## Module Dependencies
- **`backtest_visualizer_ultimate.py` (Main Backtest Script)**:
  - Calls `data_manager.load_and_preprocess_data` to load and preprocess data.
  - Uses `signal_manager.generate_and_filter_signals` to generate and filter signals, passing optimized weights.
  - Uses `backtest_engine.run_backtest` to execute the backtest.
  - Uses `optimizer.optimize_weights` to optimize signal weights for better performance.
  - Uses `visualizer.plot_backtest_results` to visualize results.
  - Uses `risk_manager.manage_risk` for risk management.
  - Uses `market_regime.detect_market_regime` to detect market conditions.

- **`signal_manager.py`**:
  - Calls `signal_generator.generate_signals` to generate raw signals, passing a `weights` dictionary for weighted signal combination.
  - Calls `signal_filter.filter_signals` to apply filters (e.g., minimum hold period, trend, volatility, confidence).
  - Depends on `transformer_model.TransformerPredictor` (via `signal_generator`) for model predictions.
  - Uses `constants` for default weights if none are provided.

- **`data_manager.py`**:
  - Calls `data_fetcher.fetch_historical_data` to load raw data from CSV or API.
  - Calls `data_preprocessor.preprocess_data` to compute features and generate signals.
  - Ensures all `FEATURE_COLUMNS` (except 'market_regime') are scaled, handling scaler compatibility.

- **`signal_generator.py`**:
  - Uses `transformer_model.TransformerPredictor` for price predictions.
  - Depends on `parameter_optimizer` for adaptive parameters (e.g., RSI thresholds, MACD periods).
  - Uses `position_sizer` for position sizing based on ATR and risk parameters.
  - Uses `utils.sequence_utils` for creating input sequences for the transformer model.
  - Uses `utils.time_utils` for halving-related calculations (e.g., `days_to_next_halving`).
  - Combines signals from multiple sources (LuxAlgo, TrendSpider, SMRT Scalping, MetaStock, model predictions) using weights.

- **`data_preprocessor.py`**:
  - Computes features defined in `constants.FEATURE_COLUMNS` (e.g., technical indicators, market regime).
  - Uses `signal_filter.smrt_scalping_signals` to generate SMRT scalping signals if `USE_SMRT_SCALPING` is `True`.
  - Depends on `utils.time_utils` for halving-related features (e.g., `days_to_next_halving`, `days_since_last_halving`).
  - Generates signals like LuxAlgo and TrendSpider signals during preprocessing.

- **`optimizer.py`**:
  - Calls `signal_generator.generate_signals` to regenerate signals with different weight combinations, passing a `weights` dictionary.
  - Uses `signal_filter.filter_signals` to filter signals before backtesting.
  - Uses `backtest_engine.backtest_strategy` to compute the Sharpe ratio for each weight combination.
  - Uses `data_preprocessor.scale_features` to scale features for signal generation.

- **`parameter_optimizer.py`**:
  - Uses `market_regime.detect_market_regime` to adapt parameters based on market conditions.
  - Uses `indicators.compute_adx` to optimize parameters based on trend strength.
  - Uses `constants.USE_LUXALGO_SIGNALS` to toggle LuxAlgo-specific parameter optimization.

- **`position_sizer.py`**:
  - Used by `signal_generator.py` and `risk_manager.py` to calculate position sizes.
  - Aligns with `signal_generator.py`’s ATR-based stop-loss/take-profit calculations.

- **`risk_manager.py`**:
  - Uses `position_sizer.py` for position sizing adjustments.
  - Aligns with `signal_generator.py`’s ATR-based stop-loss/take-profit logic.
  - Provides adjusted signals to `backtest_engine.py` for backtesting.

- **`sentiment_analysis.py`**:
  - Uses preprocessed data from `data_preprocessor.py` to compute sentiment scores.
  - Can be integrated with `signal_generator.py` to adjust signal confidence or weights (future enhancement).

- **`signal_filter.py`**:
  - Filters signals from `signal_generator.py` based on market conditions, trends, and confidence thresholds.
  - Generates SMRT scalping signals if enabled by `constants.USE_SMRT_SCALPING`.
  - Uses `indicators.calculate_atr` for SMRT scalping signal generation.

## Additional Notes
- **Log Files**: Various `.log` files (e.g., `indicators.log`, `sentiment.log`, `signals.log`) store runtime logs for debugging. Logs are standardized across modules with a consistent format (`%(asctime)s - %(levelname)s - %(name)s - %(message)s`).
- **Tests**: The `tests/` directory contains unit tests to validate components like `data_fetcher.py` and `paper_trader.py`.
- **API and Trading**: The `api/` and `trading/` directories support live trading and real-time data via Coinbase, Gemini, and a paper trading simulator.
- **Weights in Signal Generation**:
  - The `signal_manager.py` and `optimizer.py` modules pass a `weights` dictionary to `signal_generator.py` to influence how signals from different sources (LuxAlgo, TrendSpider, SMRT Scalping, MetaStock, model predictions) are combined.
  - Weights are defined in `constants.py` (e.g., `WEIGHT_LUXALGO`, `WEIGHT_TRENDSPIDER`) and optimized by `optimizer.py` to maximize the Sharpe ratio.
- **K-Fold Cross-Validation**:
  - The `train_transformer_model.py` script now supports k-fold cross-validation (5 folds by default), generating fold-specific models (`best_model_foldX.pth`) and metrics (`fold_metrics.json`).
  - Checkpoints are saved per epoch and per fold (`checkpoint_foldX_epochY.pth`) to allow resumption of training.
- **Enhanced Documentation**: All modules include detailed docstrings with purpose, integrations, future considerations, and dependencies, improving maintainability and communication.
- **Future Enhancements**:
  - Consider integrating weights into `signal_filter.py` for confidence-based filtering.
  - Implement dynamic weight optimization in `parameter_optimizer.py` based on backtesting results.
  - Optimize performance by parallelizing grid search in `optimizer.py` or using more advanced optimization algorithms (e.g., Bayesian optimization).
  - Add real-time sentiment analysis in `sentiment_analysis.py` using the X API when available.
  - Add logic to resume training from checkpoints in `train_transformer_model.py`.